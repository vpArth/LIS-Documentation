# Спецификация интеграции МИС "Дока+" с ЛИС.
## Содержание
 * HTTP методы - справочник необходимых методов для реализации интеграции
 * Общее описание - Описание основных процессов взаимодействия для понимания сути процесса
 * Спецификация - Детальное описание методов и передаваемых параметров
 * Пример использования - Логи выполнения реальных запросов для наглядности
 * Заключение - Общая сводка требований для успешного взаимодействия


## HTTP методы
--------------

### HTTP методы ЛИС.
    Все HTTP пути к ЛИС приводятся для примера и легко настраиваются в МИС
    - Метод аутентификации. `/login`
    - Метод деаутентификации. `/logout`
    - Метод приёма заказов. `/misapi/putOrders`
    - Метод приёма штрихкода. `/misapi/putBarcode`
    - Метод отмены заказа. `/misapi/cancelOrder`
    - Метод передачи/обновления данных пациента. `/misapi/putPatients`

### HTTP методы МИС.
    В МИС для интеграции предусмотрена единая точка входа `/docaplus/docaarth/act.php`
    Эта точка входа может измениться в будущем, поэтому нужна возможность её изменять в конфигурации ЛИС.
    Вызываемый метод определяется GET параметром `action` (настраиваемые)
        - Метод приёма результатов `action=resultsToMis`
    Второстепенные методы:
        - Метод передачи заказов `action=orderToLis&id_res=X` (вызывается автоматически при заказе ОиВ, повторной передаче)
        - Метод передачи штрихкода `action=barcodeToLis&id_res=X` (вызывается автоматически при вводе штрихкода)
        - Метод отмены заказа `action=cancelToLis&id_res=X` (вызывается автоматически при отмене заказа ОиВ)
        - Метод передачи/обновления данных пациента `action=patientToLis&id_pat=X` (вызывается автоматически при регистрации/изменении данных пациента)
        - Метод поиска пациента `action=searchPat` (не является необходимым)


## Общее описание
--------------
Интеграция реализована в виде общения `МИС` с сервером `ЛИС` по протоколу `HTTP` в формате `JSON`.

Процесс взаимодействия состоит из двух этапов:
 1. Передача данных о заказе нового ОиВ(обследования и воздействия) в ЛИС
 2. Прием результатов по выполненным исследованиям

### Идентификация МИС в ЛИС.
    - ЛИС создает пользователя и сообщает его логин и пароль специалистам МИС.
    - МИС выполняет HTTP запрос на адрес ЛИС с целью авторизации. `GET /login?username=login&password=pass`
    - ЛИС возвращает токен авторизации для последующих запросов. `{"status": 0, "result": {"token": "anysecureauthtokenhere"}}`
    - В последующих запросах МИС передаёт этот токен в заголовке запроса `Auth`
    - По завершению взаимодействия МИС вызывает метод ЛИС для инвалидации токена `GET /logout`

### Передача заказанных обследований в ЛИС:
На данный момент существует 3 режима передачи заказов в ЛИС(ключ `mode` в конфигурационном файле):
 1. Заказ передаётся сразу, затем, в случае необходимости, к нему отдельным запросом передаётся штрихкод.
 2. Заказ передаётся в момент, когда в МИС вводится штрихкод к заказу.
 3. Как **1**, но изначально генерируется штрихкод на основе номера госпитализации пациента.

    - МИС оповещает ЛИС о поступившем заказе на обследование и передает:
        - Токен авторизации в заголовке Auth
        - Данные о пациенте
        - Список заказов
    - ЛИС регистрирует полученные заказы:
        - При необходимости регистрирует нового пациента (уникальность пациента определяется по полю ext_id)
        - Назначает пациенту заказы/исследования в соответствии с переданными кодами бланков/тестов
        - По наличии подтверждённых результатов передает их МИС

### Передача штрихкода в ЛИС:
На данный момент существует 2 режима передачи штрихкода в ЛИС:
 1. Штрихкод к ранее переданному заказу передаётся отдельным запросом.
 2. Вместе со всем заказом в момент ввода штрихода.

### Передача результатов исследования:
    - При получении/подтверждении результатов исследования ЛИС отправляет запрос с результатом в МИС
    - МИС фиксирует результат

### Отмена обследования:
    - В случае отмены обследования либо удаления ошибочного обследования МИС оповещает ЛИС об этом передавая
        - Внутренний номер обследования в МИС, который передавался во время заказа


## Спецификация методов и параметров:

* Любое поле типа integer в силу динамической типизации PHP может быть представлено строкой.
* Коды ошибок не анализируются, важно только что 0 - успешная операция, а не 0 - ошибка.

## Описание методов ЛИС
### Аутентификация
* ЛИС должна принимать входящие соединения на HTTP адрес `/login`, обрабатывать параметры `username` и `password` и генерировать некий уникальный токен для последующих авторизаций.
* В принципе МИС неважно, как используется этот токен в ЛИС, если авторизация не нужна - можно передать в качестве токена любую непустую строку.
```
Направление: МИС -> ЛИС
Тип запроса: `GET`
Путь запроса: `/login`
Параметры:
    - `username` - (string) имя пользователя
    - `password` - (string) пароль пользователя
Формат ответа - JSON объект(header 'Content-type: application/json'):
    - `status` - (integer) код ошибки или 0 в случае успеха
    - `result` - (string | hash) строка с сообщением об ошибке, либо объект с данными
        - `token` - (string) токен авторизации
```

Инвалидация токена:
```
Направление: МИС -> ЛИС
Тип запроса: `GET`
Путь запроса: `/logout`
Заголовки:
    - `Auth` - токен авторизации, см. `/login`
Формат ответа - JSON объект(header 'Content-type: application/json'):
    - `status` - (integer) код ошибки или 0 в случае успеха
    - `result` - (string) строка с сообщением об ошибке, либо "ok"
```

### Передача заказанных обследований
```
Направление: МИС -> ЛИС
Тип запроса: `POST`
Путь запроса: `/misapi/putOrders`
Заголовки:
    - `Auth` - токен авторизации, см. `/login`
Параметры:
    - `data` - (array) Данные обследования
        - `patient` - (hash) данные пациента
            - `fam` - (string) фамилия
            - `nam` - (string) имя
            - `ots` - (string) отчество
            - `birth_date` - (string|integer) дата рождения: UnixTimestamp(может быть отрицательным) либо строка в формате ГГГГ-ММ-ДД (ЛИС необходимо обрабатывать оба варианта)
            - `sex` - (string) пол пациента: 'M' - мужской / 'F' - женский (в любом другом случае, считать, что пол не указан)
            - `ext_id` - (integer) Идентификатор пациента в МИС (используется для определения необходимости регистрации нового пациента, или использования имеющегося)
            - `nom` - (integer) Номер истории болезни
            - `id_hsp` - (integer) Идентификатор госпитализации пациента в МИС (не используется)
        - `orders` - (array) Список заказанных обследований (передаются все незавершенные обследования текущей госпитализации)
            - `ext_id` - (integer) Идентификатор заказа в МИС
            - `created` - (integer) UnixTimestamp даты заказа
            - `blank_code` - (string) Код бланка заказа
            - `ordered_fio` - (string) ФИО врача (пользователя МИС)
            - `cito` - (string) флаг `cito`: 'Y'/''
            - `code` - (string) <optional> Штрихкод, если есть.
            - `dep` - (hash) Данные отделения
                - `id` - Идентификатор в МИС
                - `name` - Наименование
            - `tests` - (array) Список параметров заказа
                - `ext_id` - (integer) Идентификатор параметра в МИС
                - `code` - (string) Код параметра
                - `type` - (string) Тип результата (не используется)
                - `unit` - (string) Ед.измерения (не используется)
Формат ответа - JSON объект(header 'Content-type: application/json'):
    - `status` - (integer) код ошибки или 0 в случае успеха
    - `result` - (string) строка с сообщением об ошибке, либо 'ok'
```

### Отмена обследования
```
Направление: МИС -> ЛИС
Тип запроса: `POST`
Путь запроса: `/misapi/cancelOrder`
Заголовки:
    - `Auth` - токен авторизации, см. `/login`
Параметры:
    - `ext_id` - (integer) Идентификатор заказа в МИС
Формат ответа - JSON объект(header 'Content-type: application/json'):
    - `status` - (integer) код ошибки или 0 в случае успеха
    - `result` - (string) строка с сообщением об ошибке, либо 'ok'
```

### Регистрация/обновление данных пациента
```
Направление: МИС -> ЛИС
Тип запроса: `POST`
Путь запроса: `/misapi/putOrders`
Заголовки:
    - `Auth` - токен авторизации, см. `/login`
Параметры:
    - `list` - (array) Список пациентов
      - `id` - Идентификатор пациента в МИС
      - `fam` - Фамилия
      - `nam` - Имя
      - `ots` - Отчество
      - `sex` - Пол (M/F), в ином случае, считать, что не указан
      - `birth_date` - Дата рождения в формате `Y-m-d`
Формат ответа - JSON объект(header 'Content-type: application/json'):
    - `status` - (integer) код ошибки или 0 в случае успеха
    - `result` - (string) строка с сообщением об ошибке, либо 'ok'
```
## Описание методов МИС
* МИС "Дока+" может принимать данные в виде формы `x-www-form-urlencoded`
* Текстовые данные в этом случае в кодировке utf-8, естественно, урлкодированные
* Второй возможный формат данных - `application/json`

### Передача результатов исследования параметра
```
Направление: ЛИС -> МИС
Тип запроса: `POST`
Путь запроса: `/docaplus/docaarth/act.php?action=resultsToMis`
Заголовки:
    - Content-type: application/x-www-form-urlencoded
Параметры:
    - `orders` - (hash) - список обследований
        - hash key - (integer) Идентификатор обследования в МИС (ext_id)
        - hash value - (array) - список тестов/результатов
            - `ext_id` - (integer) Идентификатор параметра в МИС (ext_id)
            - `code` - (string) Код параметра
            - `name` - (string) Наименование параметра
            - `value` - (string) Результат исследования: "12.34" / "-" / "Не обнаружено"
            - `ordered` - (string) Дата получения заказа
            - `confirmed` - (string) Дата подтверждения результата
            - `confirmed_by` - (array) ФИО подтвердившего результат: ["Иванов", "Иван", "Иванович"]
                - 0: (string) Фамилия
                - 1: (string) Имя
                - 2: (string) Отчество
```

## Пример взаимодействия:

### Аутентификация:
```
> GET /login?username=integrity&password=%D0%9F%D0%B0%D1%80%D0%BE%D0%BB%D1%8C HTTP/1.1
> Host: lis.example.com
>
< HTTP/1.1 200 OK
< Date: Fri, 27 Feb 2015 05:39:15 GMT
< Server: Apache/2.4.7 (Ubuntu)
< X-Powered-By: PHP/5.5.9-1ubuntu4.6
< Content-Length: 66
< Content-Type: application/json
<
< {"status":0,"result":{"token":"c44f394677803f4928fb5b352ce2ac5b"}}
```

### Передача заказанных обследований:
```
> POST /api/putOrders HTTP/1.1
> Host: lis.example.com
> Auth: c44f394677803f4928fb5b352ce2ac5b
> Content-type: application/json
> Content-length: 351
>
> {"data": [{"patient": {"ext_id": "1234", "id_hsp": "34513","fam": "%D0%9A%D0%B8%D0%BC", "nam": "%D0%9E%D0%BB%D0%B5%D0%B3", "ots": "%D0%9A%D0%B8%D0%BC%D0%BE%D0%B2%D0%B8%D1%87", "birth_date": "1972-06-15", "sex": "M"}, "orders": [{"ext_id": "20192", "blank_code": "biohim", "tests": [{"ext_id": 1205, "code": "T1207"}, {"ext_id": 19, "code": "Na"}]}]}]}

< HTTP/1.1 200 OK
< Date: Fri, 27 Feb 2015 05:39:15 GMT
< Content-Length: 26
< Content-Type: application/json
<
< {"status":0,"result":"ok"}
```

### Отмена заказанного обследования:
```
> POST /api/cancelOrder HTTP/1.1
> Host: lis.example.com
> Auth: c44f394677803f4928fb5b352ce2ac5b
> Content-type: application/json
> Content-length: 19
>
> {"ext_id": "20192"}

< HTTP/1.1 200 OK
< Date: Fri, 27 Feb 2015 05:39:15 GMT
< Content-Length: 26
< Content-Type: application/json
<
< {"status":0,"result":"ok"}
```

### Деаутентификация:
```
> GET /logout HTTP/1.1
> Host: lis.example.com
> Auth: c44f394677803f4928fb5b352ce2ac5b
>
< HTTP/1.1 200 OK
< Date: Fri, 27 Feb 2015 05:39:15 GMT
< Content-Length: 26
< Content-Type: application/json
<
< {"status":0,"result":"ok"}
```

### Передача результата исследования параметра:
```
> POST /docaplus/docaarth/act.php?action=get HTTP/1.1
> Host: docaplus
> Content-Type: application/x-www-form-urlencoded
> Content-length: 344
>
>order_id=243772&test_ext_id=2856&test_code=%D0%9B930570&test_name=%D0%A1%D0%B0%D1%85%D0%B0%D1%80&value=1.15&ordered=2015-02-27+14%3A55%3A37&confirmed=2015-02-27+15%3A05%3A28&confirmed_by%5B0%5D=%D0%98%D0%B2%D0%B0%D0%BD%D0%BE%D0%B2&confirmed_by%5B1%5D=%D0%98%D0%B2%D0%B0%D0%BD&confirmed_by%5B2%5D=%D0%98%D0%B2%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D1%87

< HTTP/1.1 200 OK
< Content-Length: 29
< Content-Type: application/json
<
< {"status": 0, "result": "ok"}
```

### Передача результатов исследования:
```
> POST /docaplus/docaarth/act.php?action=resultsToMis HTTP/1.1
> Host: docaplus
> Content-Type: application/x-www-form-urlencoded
> Content-length: 341
>
>orders[22222][0][ext_id]=2856&orders[22222][0][code]=97&orders[22222][0][name]=Albumin&orders[22222][0][value]=12.33&orders[22222][0][ordered]=2015-02-27+14%3A55%3A37&orders[22222][0][confirmed]=2015-02-27+15%3A05%3A28&orders[22222][0][confirmed_by][]=Surname&orders[22222][0][confirmed_by][]=Name&orders[22222][0][confirmed_by][]=ParentName

< HTTP/1.1 200 OK
< Content-Length: 29
< Content-Type: text/plain
<
< {"status": 0, "result": "ok"}
```

МИС "Дока+" успешно может интегрироваться с несколькими ЛИС одновременно. В этом случае МИС передаёт одинаковые заказы всем ЛИС, которые в свою очередь выбирают "свои" опираясь на кодификацию.

### Пример конфигурационного файла:
```json
{
    "paths": {
        "login": "/login",
        "logout": "/logout",
        "putOrders":   "/misapi/putOrders",
        "putBarcode":  "/misapi/putBarcode",
        "cancelOrder": "/misapi/cancelOrder",
        "putPatients": "/misapi/putPatients"
    },
    "list": [{
        "id": "Лаборатория 1",
        "type": "docalis",
        "host": "lis.med.org",
        "user": "integration",
        "pass": "0yzQzb",
        "mode": 1,
        "disabled": true
    }, {
        "id": "Лаборатория 2",
        "type": "ElLis",
        "host": "192.168.1.99",
        "user": "doca_plus",
        "pass": "bSf9TRk%Rd{b",
        "mode": 2,
        "paths": {
          "logout": "/deauth"
        }
    }]
}
```


## Заключение
Для успешной интеграции, ЛИС должна предоставить специалистам по МИС следующие данные:
 - `ip`/`host` - Адрес/доменное имя HTTP сервера ЛИС, для передачи запросов
 - `username` - Имя пользователя ЛИС для аутентификации МИС
 - `password` - Его пароль
 - `/login` - точка входа в API для аутентификации
 - `/logout` - точка входа в API для деаутентификации
 - `/misapi/putOrders` - точка входа в API для передачи заказов
 - `/misapi/cancelOrder` - точка входа в API для отмены заказа

Также ЛИС должна корректно(в соответствии с данной спецификацией) обрабатывать передаваемые ей данные, и отправлять результаты.

