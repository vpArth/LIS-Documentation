# Спецификация интеграции МИС "Дока+" с ЛИС.
## Содержание
 * Общее описание - Описание основных процессов взаимодействия для понимания сути процесса
 * Спецификация - Детальное описание методов и передаваемых параметров
 * Пример использования - Логи выполнения реальных запросов для наглядности
 * Заключение - Общая сводка требований для успешного взаимодействия

## Общее описание
--------------
Интеграция реализована в виде общения `МИС` с сервером `ЛИС` по протоколу `HTTP` в формате `JSON`.

Процесс взаимодействия состоит из двух этапов:
 1. Передача данных о заказе нового ОиВ(обследования и воздействия) в ЛИС
 2. Прием результатов по выполненным исследованиям

### Идентификация МИС в ЛИС.
    - ЛИС создает пользователя и сообщает его логин и пароль специалистам МИС
    - МИС выполняет HTTP запрос на адрес ЛИС с целью авторизации (/login)
    - ЛИС возвращает токен авторизации для последующих запросов
    - В последующих запросах МИС передаёт этот токен в заголовке запроса Auth
    - По завершению взаимодействия МИС вызывает метод ЛИС для инвалидации токена (/logout)

### Передача заказанных обследований:
    - МИС оповещает ЛИС о поступившем заказе на обследование и передает:
        - Токен авторизации в заголовке Auth
        - Данные о пациенте
        - Список заказов
        - HTTP URI для передачи результатов
    - ЛИС регистрирует полученные заказы:
        - При необходимости регистрирует нового пациента (уникальность пациента определяется по полю ext_id)
        - Назначает пациенту заказы/исследования в соответствии с переданными кодами бланков/тестов
        - По получении результатов передает их HTTP запросом на переданный в параметре `callback` URI

### Передача результатов исследования:
    - МИС предоставляет ЛИС HTTP URI в параметре `callback` при передаче заказов
    - ЛИС сохраняет этот URI, связывая его с переданными заказами
    - При получении/подтверждении результатов исследования ЛИС отправляет запрос с результатом на этот URI
    - МИС фиксирует результат


## Спецификация методов и параметров:

* Любое поле типа integer в силу динамической типизации может быть представлено строкой.
* Коды ошибок не анализируются, важно только что 0 - успешная операция, а не 0 - ошибка.

### Аутентификация
* LIS должна принимать входящие соединения на HTTP адрес `/login`, обрабатывать параметры `username` и `password` и генерировать некий уникальный токен для последующих авторизаций.
```
Направление: МИС -> ЛИС
Тип запроса: `GET`
Путь запроса: `/login`
Параметры: 
    - `username` - (string) имя пользователя
    - `password` - (string) пароль пользователя
Формат ответа - JSON объект(header 'Content-type: application/json'):
    - `status` - (integer) код ошибки или 0 в случае успеха
    - `result` - (string | hash) строка с сообщением об ошибке, либо объект с данными
        - `token` - (string) токен авторизации
```

### Передача заказанных обследований
```
Направление: МИС -> ЛИС
Тип запроса: `POST`
Путь запроса: `/api/putOne`
Параметры:
    - `callback` - (string) строка HTTP URI для передачи результатов обследования
    - `data` - (hash) Данные обследования
        - `patient` - (hash) данные пациента
            - `fam` - (string) фамилия
            - `nam` - (string) имя
            - `ots` - (string) отчество
            - `birth_date` - (string|integer) дата рождения: UnixTimestamp(может быть отрицательным) либо строка в формате ГГГГ-ММ-ДД (ЛИС необходимо обрабатывать оба варианта)
            - `sex` - (string) пол пациента: 'M' - мужской / 'F' - женский (в любом другом случае, считать, что пол не указан)
            - `ext_id` - (integer) Идентификатор пациента в МИС (используется для определения необходимости регистрации нового пациента, или использования имеющегося)
            - `id_hsp` - (integer) Идентификатор госпитализации пациента в МИС
        - `orders` - (array) Список заказанных обследований (передаются все незавершенные обследования текущей госпитализации)
            - `ext_id` - (integer) Идентификатор заказа в МИС
            - `blank_code` - (string) Код бланка заказа
            - `tests` - (array) Список параметров заказа
                - `ext_id` - (integer) Идентификатор параметра в МИС
                - `code` - (string) Код параметра
Формат ответа - JSON объект(header 'Content-type: application/json'):
    - `status` - (integer) код ошибки или 0 в случае успеха
    - `result` - (string) строка с сообщением об ошибке, либо 'ok'
```

### Передача результата исследования параметра
* Внимание, МИС "Дока+" принимает данные в виде формы `x-www-form-urlencoded`
* Текстовые данные в кодировке utf-8, естественно, урлкодированные
```
Направление: ЛИС -> МИС
Тип запроса: `POST`
Путь запроса: см. `callback` из [Передача заканных обследований]
Заголовки:
    - Content-type: application/x-www-form-urlencoded
Параметры:
    - `order_id` - (integer) Идентификатор заказа в МИС (ext_id)
    - `test_ext_id` - (integer) Идентификатор параметра в МИС (ext_id)
    - `test_code` - (string) Код параметра
    - `test_name` - (string) Наименование параметра
    - `value` - (string) Результат исследования: "12.34" / "-" / "Не обнаружено"
    - `ordered` - (string) Дата получения заказа
    - `verified` - (string) Дата подтверждения результата
    - `confirmed_by` - (array) ФИО подтвердившего результат: ["Иванов", "Иван", "Иванович"]
        - 0: (string) Фамилия
        - 1: (string) Имя
        - 2: (string) Отчество
```

## Пример взаимодействия:

### Аутентификация:
```
> GET /login?username=integrity&password=%D0%9F%D0%B0%D1%80%D0%BE%D0%BB%D1%8C HTTP/1.1
> Host: nicklis.vparth.info
>
< HTTP/1.1 200 OK
< Date: Fri, 27 Feb 2015 05:39:15 GMT
< Server: Apache/2.4.7 (Ubuntu)
< X-Powered-By: PHP/5.5.9-1ubuntu4.6
< Content-Length: 66
< Content-Type: application/json
<
< {"status":0,"result":{"token":"c44f394677803f4928fb5b352ce2ac5b"}}
```

### Передача заказанных обследований:
```
> POST /api/putOne HTTP/1.1
> Host: nicklis.vparth.info
> Auth: c44f394677803f4928fb5b352ce2ac5b
> Content-type: application/json
> Content-length: 408
> 
> {"callback": "http://example.ru/collect_results.php?34513", "data": {"patient": {"ext_id": "1234", "id_hsp": "34513","fam": "%D0%9A%D0%B8%D0%BC", "nam": "%D0%9E%D0%BB%D0%B5%D0%B3", "ots": "%D0%9A%D0%B8%D0%BC%D0%BE%D0%B2%D0%B8%D1%87", "birth_date": "1972-06-15", "sex": "M"}, "orders": [{"ext_id": "20192", "blank_code": "biohim", "tests": [{"ext_id": 1205, "code": "T1207"}, {"ext_id": 19, "code": "Na"}]}]}}
< HTTP/1.1 200 OK
< Date: Fri, 27 Feb 2015 05:39:15 GMT
< Server: Apache/2.4.7 (Ubuntu)
< X-Powered-By: PHP/5.5.9-1ubuntu4.6
< Content-Length: 26
< Content-Type: application/json
<
< {"status":0,"result":"ok"}
```

### Деаутентификация:
```
> GET /login?username=integrity&password=%D0%9F%D0%B0%D1%80%D0%BE%D0%BB%D1%8C HTTP/1.1
> Host: nicklis.vparth.info
> Auth: c44f394677803f4928fb5b352ce2ac5b
>
< HTTP/1.1 200 OK
< Date: Fri, 27 Feb 2015 05:39:15 GMT
< Server: Apache/2.4.7 (Ubuntu)
< X-Powered-By: PHP/5.5.9-1ubuntu4.6
< Content-Length: 26
< Content-Type: application/json
<
< {"status":0,"result":"ok"}
```

### Передача результата исследования параметра:
```
> POST /docaplus/docaarth/act.php?action=get&lis=docalis HTTP/1.1
> Host: docaplus
> Content-Type: application/x-www-form-urlencoded
> Content-length: 343
>
>order_id=243772&test_ext_id=2856&test_code=%D0%9B930570&test_name=%D0%A1%D0%B0%D1%85%D0%B0%D1%80&value=1.15&ordered=2015-02-27+14%3A55%3A37&verified=2015-02-27+15%3A05%3A28&confirmed_by%5B0%5D=%D0%98%D0%B2%D0%B0%D0%BD%D0%BE%D0%B2&confirmed_by%5B1%5D=%D0%98%D0%B2%D0%B0%D0%BD&confirmed_by%5B2%5D=%D0%98%D0%B2%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D1%87
< HTTP/1.1 200 OK
< Date: Fri, 27 Feb 2015 05:39:15 GMT
< Server: Apache/2.4.7 (Ubuntu)
< Content-Length: 0
< Content-Type: text/plain
<
< 
```

## Заключение
Для успешной интеграции, ЛИС должна предоставить специалистам по МИС следующие данные:
 - `ip`/`host` - Адрес/доменное имя HTTP сервера ЛИС, для передачи запросов
 - `/api/putOne` - Опционально, при необходимости можно сменить точку входа для передачи заказов
 - `username` - Имя пользователя ЛИС для аутентификации МИС
 - `password` - Его пароль
Также ЛИС должна корректно(в соответствии с данной спецификацией) обрабатывать передаваемые ей данные, и отправлять результаты.
